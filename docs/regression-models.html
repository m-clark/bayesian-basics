<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Chapter 4 Regression Models | Bayesian Basics</title>

  
   <meta name="description" content="This document provides an introduction to Bayesian data analysis. It is conceptual in nature, but uses the probabilistic programming language Stan for demonstration (and its implementation in R via rstan). From elementary examples, guidance is provided for data preparation, efficient modeling, diagnostics, and more." />
   <meta name="generator" content="placeholder" />
  <meta property="og:title" content="Chapter 4 Regression Models | Bayesian Basics" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://m-clark.github.io/bayesian-basics/" />
  <meta property="og:image" content="https://m-clark.github.io/bayesian-basics//img/nineteeneightyR.png" />
  <meta property="og:description" content="This document provides an introduction to Bayesian data analysis. It is conceptual in nature, but uses the probabilistic programming language Stan for demonstration (and its implementation in R via rstan). From elementary examples, guidance is provided for data preparation, efficient modeling, diagnostics, and more." />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Regression Models | Bayesian Basics" />
  
  <meta name="twitter:description" content="This document provides an introduction to Bayesian data analysis. It is conceptual in nature, but uses the probabilistic programming language Stan for demonstration (and its implementation in R via rstan). From elementary examples, guidance is provided for data preparation, efficient modeling, diagnostics, and more." />
  <meta name="twitter:image" content="https://m-clark.github.io/bayesian-basics//img/nineteeneightyR.png" />
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.3.1/transition.js"></script>
    <script src="libs/bs3compat-0.3.1/tabs.js"></script>
    <script src="libs/bs3compat-0.3.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
    <script src="libs/plotly-binding-4.10.0/plotly.js"></script>
    <script src="libs/typedarray-0.1/typedarray.min.js"></script>
    <link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
    <link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
    <script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script>

  <!-- CSS -->
  
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bayesian Basics</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="regression-models" class="section level1" number="4">
<h1><span class="header-section-number">Chapter 4</span> Regression Models</h1>
<p>Now armed with a conceptual understanding of the Bayesian approach, we will actually investigate a regression model using it. To keep things simple, we start with a standard linear model for regression. Later, we will show how easy it can be to add changes to the sampling distribution or priors for alternative modeling techniques. But before getting too far, you should peruse the <a href="appendix.html#modeling-languages">Modeling Languages</a> section of the appendix to get a sense of some of the programming approaches available. We will be using the programming language Stan via R and the associated R package <span class="pack">rstan</span>. If you prefer to keep things conceptual rather than worry about the code, you can read through the following data description and then skip to <a href="regression-models.html#running-the-model">running the model</a><a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a>.</p>
<div id="example-linear-regression-model" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Example: Linear Regression Model</h2>
<p>In the following we will have some initial data set up and also run the model using the standard <span class="func">lm</span> function for later comparison. I choose simulated data so that not only should you know what to expect from the model, it can easily be modified to enable further understanding. I will also use some matrix operations, and if these techniques are unfamiliar to you, you’ll perhaps want to do some refreshing or learning on your own beforehand.</p>
<div id="setup" class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Setup</h3>
<p>First we need to create the data we’ll use here and for most of the other examples in this document. I use simulated data so that there is no ambiguity about what to expect.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="regression-models.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for replicability</span></span>
<span id="cb13-2"><a href="regression-models.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8675309</span>)</span>
<span id="cb13-3"><a href="regression-models.html#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="regression-models.html#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create a N x k matrix of covariates</span></span>
<span id="cb13-5"><a href="regression-models.html#cb13-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">250</span></span>
<span id="cb13-6"><a href="regression-models.html#cb13-6" aria-hidden="true" tabindex="-1"></a>K <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb13-7"><a href="regression-models.html#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="regression-models.html#cb13-8" aria-hidden="true" tabindex="-1"></a>covariates <span class="ot">=</span> <span class="fu">replicate</span>(K, <span class="fu">rnorm</span>(<span class="at">n =</span> N))</span>
<span id="cb13-9"><a href="regression-models.html#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(covariates) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;X1&#39;</span>, <span class="st">&#39;X2&#39;</span>, <span class="st">&#39;X3&#39;</span>)</span>
<span id="cb13-10"><a href="regression-models.html#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="regression-models.html#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create the model matrix with intercept</span></span>
<span id="cb13-12"><a href="regression-models.html#cb13-12" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">Intercept =</span> <span class="dv">1</span>, covariates)</span>
<span id="cb13-13"><a href="regression-models.html#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="regression-models.html#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># create a normally distributed variable that is a function of the covariates</span></span>
<span id="cb13-15"><a href="regression-models.html#cb13-15" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, .<span class="dv">2</span>, <span class="sc">-</span><span class="fl">1.5</span>, .<span class="dv">9</span>)</span>
<span id="cb13-16"><a href="regression-models.html#cb13-16" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> X <span class="sc">%*%</span> coefs</span>
<span id="cb13-17"><a href="regression-models.html#cb13-17" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb13-18"><a href="regression-models.html#cb13-18" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnorm</span>(N, mu, sigma)</span>
<span id="cb13-19"><a href="regression-models.html#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="regression-models.html#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co"># same as</span></span>
<span id="cb13-21"><a href="regression-models.html#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># y = 5 + .2*X1 - 1.5*X2 + .9*X3 + rnorm(N, mean = 0, sd = 2)</span></span>
<span id="cb13-22"><a href="regression-models.html#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="regression-models.html#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Run lm for later comparison; but go ahead and examine now if desired</span></span>
<span id="cb13-24"><a href="regression-models.html#cb13-24" aria-hidden="true" tabindex="-1"></a>modlm <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> ., <span class="at">data =</span> <span class="fu">data.frame</span>(X[, <span class="sc">-</span><span class="dv">1</span>]))</span>
<span id="cb13-25"><a href="regression-models.html#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(modlm)</span></span></code></pre></div>
<p>Just to make sure we’re on the same page, at this point we have three covariates, and a <span class="math inline">\(y\)</span> that is a normally distributed, linear function of them, and with standard deviation equal to 2. The population values for the coefficients including the intercept are 5, 0.2, -1.5, and 0.9, though with the noise <code>sigma</code> added, the actual estimated values for the sample are slightly different. Now we are ready to set up an R list object of the data for input into Stan, as well as the corresponding Stan code to model this data. I will show all the Stan code, which is implemented in R via a single character string, and then provide some detail on each corresponding model block. However, the goal here isn’t to focus on tools as much as it is to focus on concepts<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>.</p>
<p>The data list for Stan should include any matrix, vector, or value that might be used in the Stan code. For example, along with the data one can include things like sample size, group indicators (e.g. for mixed models) and so forth. Here we can get by with just the sample size (N), the number of columns in the model matrix (K), the target variable (y) and the model matrix itself (X).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="regression-models.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the data list object for Stan input</span></span>
<span id="cb14-2"><a href="regression-models.html#cb14-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb14-3"><a href="regression-models.html#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb14-4"><a href="regression-models.html#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">K =</span> <span class="fu">ncol</span>(X),</span>
<span id="cb14-5"><a href="regression-models.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb14-6"><a href="regression-models.html#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X</span>
<span id="cb14-7"><a href="regression-models.html#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Next comes the Stan code. In something like <span class="pack">rjags</span>, you would call a separate text file with the code, and one can do the same with <span class="pack">rstan</span><a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>, but for our purposes, we’ll display it within the R code. The first thing to note then is the model code. Next, Stan has programming blocks that have to be called in order. I will have all of the blocks in the code to note their order and discuss each in turn, even though we won’t use them all. Anything following a <code>//</code>, or between <code>\* \*</code>, are comments pertaining to the code. Assignments in Stan are <code>=</code>, while distributions are specified with a <span class="math inline">\(\sim\)</span>, e.g. <code>y ~ normal(0, 1)</code> means y is normally distributed with mean 0 and standard deviation of 1.</p>
<p>The primary goal here is to get to the results and beyond, but one should examine the <a href="https://mc-stan.org/users/documentation/">Stan manual</a> for details about the code. In addition, to install <span class="pack">rstan</span> one will need to do so via CRAN or GitHub (<a href="https://github.com/Stan-dev/rstan/wiki/RStan-Getting-Started">quickstart guide</a>). It does not require a separate installation of Stan itself, but it does take a couple steps, and does require a C++ compiler<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>. Once you have <span class="pack">rstan</span> installed it is called like any other R package as will see shortly.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="regression-models.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Stan model object using Stan&#39;s syntax</span></span>
<span id="cb15-2"><a href="regression-models.html#cb15-2" aria-hidden="true" tabindex="-1"></a>stanmodelcode <span class="ot">=</span> <span class="st">&quot;</span></span>
<span id="cb15-3"><a href="regression-models.html#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">data {                      // Data block</span></span>
<span id="cb15-4"><a href="regression-models.html#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower = 1 &gt;  N;       // Sample size</span></span>
<span id="cb15-5"><a href="regression-models.html#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower = 1&gt; K;         // Dimension of model matrix</span></span>
<span id="cb15-6"><a href="regression-models.html#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[N, K] X;           // Model Matrix</span></span>
<span id="cb15-7"><a href="regression-models.html#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] y;              // Target variable</span></span>
<span id="cb15-8"><a href="regression-models.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-9"><a href="regression-models.html#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="regression-models.html#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="st">/* </span></span>
<span id="cb15-11"><a href="regression-models.html#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data {          // Transformed data block. Not used presently.</span></span>
<span id="cb15-12"><a href="regression-models.html#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="st">} </span></span>
<span id="cb15-13"><a href="regression-models.html#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">*/</span></span>
<span id="cb15-14"><a href="regression-models.html#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="regression-models.html#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {                // Parameters block</span></span>
<span id="cb15-16"><a href="regression-models.html#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[K] beta;           // Coefficient vector</span></span>
<span id="cb15-17"><a href="regression-models.html#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower = 0&gt; sigma;    // Error scale, lower bound at 0</span></span>
<span id="cb15-18"><a href="regression-models.html#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-19"><a href="regression-models.html#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="regression-models.html#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="st">model {                     // Model block</span></span>
<span id="cb15-21"><a href="regression-models.html#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] mu;</span></span>
<span id="cb15-22"><a href="regression-models.html#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = X * beta;            // Creation of linear predictor</span></span>
<span id="cb15-23"><a href="regression-models.html#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb15-24"><a href="regression-models.html#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="st">  // priors</span></span>
<span id="cb15-25"><a href="regression-models.html#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="st">  beta  ~ normal(0, 10);</span></span>
<span id="cb15-26"><a href="regression-models.html#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ cauchy(0, 5);     // With sigma bounded, this is half-cauchy</span></span>
<span id="cb15-27"><a href="regression-models.html#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb15-28"><a href="regression-models.html#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="st">  // likelihood</span></span>
<span id="cb15-29"><a href="regression-models.html#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="st">  y ~ normal(mu, sigma);</span></span>
<span id="cb15-30"><a href="regression-models.html#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-31"><a href="regression-models.html#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="regression-models.html#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="st">/*</span></span>
<span id="cb15-33"><a href="regression-models.html#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {      // Generated quantities block. Not used presently.</span></span>
<span id="cb15-34"><a href="regression-models.html#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-35"><a href="regression-models.html#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="st">*/</span></span>
<span id="cb15-36"><a href="regression-models.html#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span></span></code></pre></div>
</div>
<div id="stan-code" class="section level3" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Stan Code</h3>
<p>The first section is the <em>data</em> block, where we tell Stan the data it should be expecting from the data list. It is useful to put in bounds as a check on the data input, and that is what is being done between the <code>&lt; &gt;</code> (e.g. we should at least have a sample size of 1). The first two variables declared are <code>N</code> and <code>K</code>, both as integers. Next the code declares the model matrix and target vector respectively. As you’ll note here and for the next blocks, we declare the type and dimensions of the variable and then its name. In Stan, everything declared in one block is available to subsequent blocks, but those declared in a block may not be used in earlier blocks. Even within a block, anything declared, such as <code>N</code> and <code>K</code>, can then be used subsequently, as we did to specify dimensions of the model matrix <code>X</code>.</p>
<p>For a reference, the following is from an older version of the Stan manual, but I think still helps clarify a bit (see the latest section <a href="https://mc-stan.org/docs/2_28/reference-manual/overview-of-stans-program-blocks.html">here</a>), and notes variables of interest and the associated blocks where they would be declared.</p>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:center;">
Variable Kind
</th>
<th style="text-align:center;">
Declaration Block
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
modeled, unmodeled data
</td>
<td style="text-align:center;">
data, transformed data
</td>
</tr>
<tr>
<td style="text-align:center;">
modeled parameters, missing data
</td>
<td style="text-align:center;">
parameters, transformed parameters
</td>
</tr>
<tr>
<td style="text-align:center;">
unmodeled parameters
</td>
<td style="text-align:center;">
data, transformed data
</td>
</tr>
<tr>
<td style="text-align:center;">
generated quantities
</td>
<td style="text-align:center;">
transformed data, transformed parameters, generated quantities
</td>
</tr>
<tr>
<td style="text-align:center;">
loop indices
</td>
<td style="text-align:center;">
loop statement
</td>
</tr>
</tbody>
</table>
<p>The <em>transformed data</em> block is where you could do such things as log or center variables and similar, i.e. you can create new data based on the input data, or just in general. If you are using R though, it would almost always be easier to do those things in R first and just include them in the data list. You can also declare any unmodeled parameters here, e.g. constants you want fixed at some value.</p>
<p>The primary parameters of interest that are to be estimated go in the <em>parameters</em> block. As with the data block, you can only declare these variables, you cannot make any assignments. Here we note the <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span> to be estimated, with a lower bound of zero on the latter. In practice, you might prefer to split out the intercept or other coefficients to be modeled separately if they are on notably different scales.</p>
<p>The <em>transformed parameters</em> block is where optional parameters of interest might be included. What might go here is fairly open, but for efficiency’s sake you will typically want to put things only of specific interest that are dependent on the parameters block. These are evaluated along with the parameters, so if the objects are not of special interest you can instead generate them in the model or generated quantities block to save time.</p>
<p>The <em>model</em> block is where your priors and likelihood are specified, along with the declaration of any variables necessary. As an example, the linear predictor is included here, as it will go towards the likelihood<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a>. Note that we could have instead put the linear predictor in the transformed parameters section, but this would slow down the process, and again, we’re not so interested in those specific values.</p>
<p>I use a normal prior for the coefficients with a zero mean and a very large standard deviation to reflect my notable ignorance here<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>. For the <span class="math inline">\(\sigma\)</span> estimate I use a Cauchy distribution<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>. Many regression examples using BUGS will use an inverse gamma prior, which is perfectly okay for this model, though it would not work so well for other variance parameters. Had we not specified anything for the prior distribution for the parameters, vague, uniform distributions would be the default (discussed more in the <a href="issues.html#choice-of-prior">Choice of Prior section</a>). The likelihood is specified in a similar manner as one would with R. BUGS style languages would actually use <span class="func">dnorm</span> as in R, though Stan uses <span class="func">normal</span> for the function name.</p>
<p>Finally, we get to the <em>generated quantities</em>, which is kind of a fun zone. Anything you want to calculate can go here - predictions on new data, ratios of parameters, how many times a parameter is greater than x, transformations of parameters for reporting purposes, and so forth. We will demonstrate this later.</p>
</div>
<div id="running-the-model" class="section level3" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> Running the Model</h3>
<p>Now that we have an idea of what the code is doing, let’s put it to work. Bayesian estimation, like maximum likelihood, starts with initial guesses as starting points and then runs in an iterative fashion, producing simulated draws from the posterior distribution at each step, and then adjusting those draws until finally getting to some target, or <em>stationary</em> distribution. This part is key, and different from classical statistics. We are aiming for a <em>distribution</em>, not a <em>point estimate</em>.</p>
<p>The simulation process is referred to as <em>Markov Chain Monte Carlo</em>, or MCMC for short. The specifics of this process are what sets many of the Bayesian programming languages/approaches apart, and something we will cover in more detail in a later section (see <a href="issues.html#sampling-procedure">Sampling Procedure</a>). In MCMC, all of the simulated draws from the posterior are based on, and correlated with, previous draws<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>, as the process moves along the path toward a stationary distribution. We will typically allow the process to <em>warm up</em>, or rather get a bit settled down from the initial starting point, which might be way off, and thus the subsequent estimates will also be way off for the first few iterations<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a>. Rest assured, assuming the model and data are otherwise acceptable, the process will get to where it needs to go. However, as a further check, we will run the whole thing multiple times, i.e. have more than one <em>chain</em>. As the chains will start from different places, if multiple chains get to the same place in the end, we can feel more confident about our results.</p>
<p>While this process may sound like it might take a long time to complete, for the following you’ll note that it will take much more time for Stan to compile its code to C++ than it will to run the model<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a>, and on my computer each chain only takes less than one-tenth of a second. However, the Bayesian approach used to take a very long time even for a standard regression such as this, and that is perhaps the primary reason why Bayesian analysis only caught on in the last couple decades; we simply didn’t have the machines to do it efficiently. Even now though, for highly complex models and large data sets it can still take a long time to run, though typically not prohibitively so.</p>
<p>In the following code, we note the object that contains the Stan model code, the data list, how many iterations we want (2000)<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a>, how long we want the process to run before we start to keep any estimates (<code>warmup = 1000</code>), how many of the post-warmup draws of the posterior we want to keep (<code>thin = 4</code> means every fourth draw), and the number of chains (<code>chains = 4</code>). In the end, we will have four chains for a total of 1000<a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a> draws from the posterior distribution of the parameters. Stan spits out a lot of output to the R console even with <code>verbose = FALSE</code>, and I omit it here, but you will see some initial info about the compiling process, updates as each chain gets through 10% of iterations specified in the <code>iter</code> argument, and finally an estimate of the elapsed time. You may also see <em>informational messages</em> which, unless they are highly repetitive, should not be taken as an error.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="regression-models.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb16-2"><a href="regression-models.html#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="regression-models.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="do">### Run the model and examine results</span></span>
<span id="cb16-4"><a href="regression-models.html#cb16-4" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">stan</span>(</span>
<span id="cb16-5"><a href="regression-models.html#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> stanmodelcode,</span>
<span id="cb16-6"><a href="regression-models.html#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data   =</span> dat,</span>
<span id="cb16-7"><a href="regression-models.html#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter   =</span> <span class="dv">2000</span>,</span>
<span id="cb16-8"><a href="regression-models.html#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb16-9"><a href="regression-models.html#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin   =</span> <span class="dv">4</span>,</span>
<span id="cb16-10"><a href="regression-models.html#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span></span>
<span id="cb16-11"><a href="regression-models.html#cb16-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>With the model run, we can now examine the results. In the following, we specify the digit precision to display, which parameters we want (not necessary here), and which quantiles of the posterior draws we want, which in this case are the median and those that would produce a 95% interval estimate.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="regression-models.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb17-2"><a href="regression-models.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(</span>
<span id="cb17-3"><a href="regression-models.html#cb17-3" aria-hidden="true" tabindex="-1"></a>  fit,</span>
<span id="cb17-4"><a href="regression-models.html#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars   =</span> <span class="fu">c</span>(<span class="st">&#39;beta&#39;</span>, <span class="st">&#39;sigma&#39;</span>),</span>
<span id="cb17-5"><a href="regression-models.html#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb17-6"><a href="regression-models.html#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob   =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>)</span>
<span id="cb17-7"><a href="regression-models.html#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=4; 
post-warmup draws per chain=250, total post-warmup draws=1000.

          mean se_mean    sd   2.5%    50%  97.5% n_eff  Rhat
beta[1]  4.891   0.004 0.123  4.648  4.889  5.142  1142 1.000
beta[2]  0.083   0.004 0.131 -0.163  0.083  0.336   912 1.006
beta[3] -1.473   0.004 0.129 -1.728 -1.475 -1.215   910 0.999
beta[4]  0.819   0.004 0.119  0.583  0.816  1.059   988 0.999
sigma    2.033   0.003 0.090  1.859  2.029  2.211   844 0.998

Samples were drawn using NUTS(diag_e) at Sat Feb 19 11:21:03 2022.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
<p>So far so good. The mean estimates reflect the mean of posterior draws for the parameters of interest, and are the typical coefficients reported in standard regression analysis. The 95% probability, or <em>credible intervals</em>, are worth noting, because <em>they are not confidence intervals as you know them</em>. There is no repeated sampling interpretation here<a href="#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a>. The probability interval is more intuitive. It means simply that, based on the results of this model, there is a 95% chance the true value will fall between those two points. The other values printed out I will return to in just a moment.</p>
<p>Comparing the results to those from R’s <span class="func">lm</span> function, we can see we obtain similar estimates, as they are identical to two decimal places. In fact, had we used uniform priors<a href="#fn28" class="footnote-ref" id="fnref28"><sup>28</sup></a>, we would be doing essentially the same model as what is being conducted with standard maximum likelihood estimation. Here, we have a decent amount of data for a model that isn’t complex, so we would expect the likelihood to notably outweigh the prior, as we demonstrated previously with our binomial example.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="regression-models.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modlm)</span></code></pre></div>
<table style="width:90%;">
<colgroup>
<col width="25%" />
<col width="15%" />
<col width="18%" />
<col width="13%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="center"> </th>
<th align="right">Estimate</th>
<th align="right">Std. Error</th>
<th align="right">t value</th>
<th align="right">Pr(&gt;|t|)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><strong>(Intercept)</strong></td>
<td align="right">4.898</td>
<td align="right">0.1284</td>
<td align="right">38.13</td>
<td align="right">3.026e-105</td>
</tr>
<tr class="even">
<td align="center"><strong>X1</strong></td>
<td align="right">0.08408</td>
<td align="right">0.1296</td>
<td align="right">0.6488</td>
<td align="right">0.5171</td>
</tr>
<tr class="odd">
<td align="center"><strong>X2</strong></td>
<td align="right">-1.469</td>
<td align="right">0.1261</td>
<td align="right">-11.64</td>
<td align="right">3.049e-25</td>
</tr>
<tr class="even">
<td align="center"><strong>X3</strong></td>
<td align="right">0.8196</td>
<td align="right">0.1207</td>
<td align="right">6.793</td>
<td align="right">8.207e-11</td>
</tr>
</tbody>
</table>
<table style="width:88%;">
<caption>Fitting linear model: y ~ .</caption>
<colgroup>
<col width="20%" />
<col width="30%" />
<col width="12%" />
<col width="23%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">Observations</th>
<th align="center">Residual Std. Error</th>
<th align="center"><span class="math inline">\(R^2\)</span></th>
<th align="center">Adjusted <span class="math inline">\(R^2\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">250</td>
<td align="center">2.021</td>
<td align="center">0.4524</td>
<td align="center">0.4458</td>
</tr>
</tbody>
</table>
<p>But how would we know if our model was working out okay otherwise? There are several standard diagnostics, and we will talk about them in more detail in the next section, but let’s take a look at some presently. In the summary, <code>se_mean</code> is the <em>Monte Carlo error</em>, and is an estimate of the uncertainty contributed by only having a finite number of posterior draws. <code>n_eff</code> is <em>effective sample size</em> given all chains, and essentially accounts for autocorrelation in the chain, i.e. the correlation of the estimates as we go from one draw to the next. It actually doesn’t have to be very large, but if it was small relative to the total number of draws desired, that might be cause for concern. <code>Rhat</code> is a measure of how well chains mix, and goes to 1 as chains are allowed to run for an infinite number of draws. In this case, <code>n_eff</code> and <code>Rhat</code> suggest we have good convergence, but we can also examine this visually with a traceplot.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="regression-models.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb20-2"><a href="regression-models.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_trace</span>(fit, <span class="at">pars=</span><span class="fu">c</span>(<span class="st">&#39;beta[4]&#39;</span>))</span></code></pre></div>
<p><img  src="img/traceplotWarmup.svg" width=75% style="display:block; margin: 0 auto;"></p>
<p>I only show one parameter above, but one should always look at the traceplots for all parameters. What we are looking for after the warmup period is a “fat hairy caterpillar” or something that might be labeled as “grassy,” and this plot qualifies as such<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>. One can see that the estimates from each chain find their way from the starting point to a more or less steady state quite rapidly (initial warmup iterations in gray). Furthermore, all chains, each noted by a different color, are mixing well and bouncing around the same conclusion. So the statistical measures and traceplot suggest that we are doing okay.</p>
<p>The Stan development crew has made it easy to interactively explore diagnostics via the <span class="pack">shinystan</span> package, and one should do so with each model. In addition, there are other diagnostics available in other packages like <span class="pack">loo</span> and <span class="pack">posterior</span>.</p>
<p>So there you have it. Aside from the initial setup with making a data list and producing the language-specific model code, it doesn’t necessarily take much to running a Bayesian regression model relative to standard models<a href="#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a>. The main thing perhaps is simply employing a different mindset, and interpreting the results from within that new perspective. For the standard models you are familiar with, it probably won’t take too long to be as comfortable here as you were with those, and now you will have a flexible tool to take you into new realms with deeper understanding.</p>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="15">
<li id="fn15"><p>For just a standard regression model I would ultimately suggest using <span class="pack">rstanarm</span> or <span class="pack">brms</span>, because they would allow you to keep to the usual R approach for modeling, allowing you to more or less jump right in. However, writing Stan code makes it clearer what is being done, so we’ll keep to it for our purposes here. When I first started writing this document, <span class="pack">brms</span> didn’t exist, <span class="pack">rstanarm</span> was still in its infancy, there was no interactive <span class="pack">shinystan</span> etc. I may end up moving the Stan code to the appendix and just using <span class="pack">rstanarm</span> in the future, but I think it’s worth knowing what’s actually going on specifically behind the scenes, so will stick to the <span class="pack">rstan</span> approach for now.<a href="regression-models.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p>Related code for this same model in BUGS and JAGS is provided in the appendix <a href="appendix.html#bugs-example">here</a>. I don’t think there is an easy way to learn these programming languages except by diving in and using them yourself with models and data you understand. In general their modeling syntax is not too difficult to translate from Stan and often very similar.<a href="regression-models.html#fnref16" class="footnote-back">↩︎</a></p></li>
<li id="fn17"><p>In your own Stan pursuits, it’s better to have the Stan model as a separate file.<a href="regression-models.html#fnref17" class="footnote-back">↩︎</a></p></li>
<li id="fn18"><p>You can examine this <a href="https://en.wikipedia.org/wiki/List_of_compilers#C.2B.2B_compilers">list</a> of compilers, or on Windows simply install Rtools from the R website (recommended). Note that you may already have one incidentally. Try the Stan test in their ‘getting started’ guide before downloading one.<a href="regression-models.html#fnref18" class="footnote-back">↩︎</a></p></li>
<li id="fn19"><p>The position within the model block isn’t crucial. I tend to like to do all the variable declarations at the start, but others might prefer to have them under the likelihood heading at the point they are actually used.<a href="regression-models.html#fnref19" class="footnote-back">↩︎</a></p></li>
<li id="fn20"><p>By setting the prior mean to zero, this will have the effect of shrinking the coefficients toward zero to some extent. In this sense, it is equivalent to penalized regression in the non-Bayesian setting, ridge regression in particular.<a href="regression-models.html#fnref20" class="footnote-back">↩︎</a></p></li>
<li id="fn21"><p>Actually, a half-Cauchy as it is bounded to be positive. This is equivalent to a student t with df=1, and there is some tendency of late to use the student t directly with df=3 for slight gains in performance for some models.<a href="regression-models.html#fnref21" class="footnote-back">↩︎</a></p></li>
<li id="fn22"><p>In a Markov Chain, <span class="math inline">\(\theta_t\)</span> is independent of previous <span class="math inline">\(\theta_{t-2...t_1}\)</span>, conditional on <span class="math inline">\(\theta_{t-1}\)</span>.<a href="regression-models.html#fnref22" class="footnote-back">↩︎</a></p></li>
<li id="fn23"><p>How far one wants to go down the rabbit hole regarding MCMC is up to the reader. A great many applied researchers do classical statistical analysis without putting much thought into the actual maximum likelihood estimation process, and I suppose one could do so here as well.<a href="regression-models.html#fnref23" class="footnote-back">↩︎</a></p></li>
<li id="fn24"><p>Not usually the case except for simple models with smaller data.<a href="regression-models.html#fnref24" class="footnote-back">↩︎</a></p></li>
<li id="fn25"><p>This is probably overkill for a simple model like this. One probably would be fine with 500 warm-up and 500 iterations for a standard regression.<a href="regression-models.html#fnref25" class="footnote-back">↩︎</a></p></li>
<li id="fn26"><p><span class="math inline">\(\frac{2000-1000}{4} \cdot 4 = 1000\)</span><a href="regression-models.html#fnref26" class="footnote-back">↩︎</a></p></li>
<li id="fn27"><p>A standard confidence interval implies that if we’d done the study exactly the same over and over, and calculated a confidence interval each time, 95% of them would capture the true value. The one you end up with is just one from that process.<a href="regression-models.html#fnref27" class="footnote-back">↩︎</a></p></li>
<li id="fn28"><p>In Stan code this can be done by not explicitly specifying a prior.<a href="regression-models.html#fnref28" class="footnote-back">↩︎</a></p></li>
<li id="fn29"><p>Like all model diagnostics, we aren’t dealing with an exact science.<a href="regression-models.html#fnref29" class="footnote-back">↩︎</a></p></li>
<li id="fn30"><p>As noted previously, other R packages would allow for regression models to be specified just like you would with the <span class="func">lm</span> and <span class="func">glm</span> functions. See the <span class="pack">rstanarm</span> (from the developers of Stan) and <span class="pack">brms</span> packages especially.<a href="regression-models.html#fnref30" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Basics</strong>" was written by <p><span class="noem">Michael Clark</span> <br>
<a href="https://m-clark.github.io/">m-clark.github.io</a></p>. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
<script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>

</html>
