<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Bayesian Basics</title>
  <meta name="description" content="An introduction to Bayesian data analysis.">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Bayesian Basics" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://m-clark.github.io/Workshops/text_analysis/" />
  <meta property="og:image" content="https://m-clark.github.io/Workshops/text_analysis/img/nineteeneightyR.png" />
  <meta property="og:description" content="An introduction to Bayesian data analysis." />
  <meta name="github-repo" content="m-clark/docs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Bayesian Basics" />
  
  <meta name="twitter:description" content="An introduction to Bayesian data analysis." />
  <meta name="twitter:image" content="https://m-clark.github.io/Workshops/text_analysis/img/nineteeneightyR.png" />



<meta name="date" content="2017-07-22">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="regression-models.html">
<link rel="next" href="model-enhancements.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.9/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css\book.css" type="text/css" />
<link rel="stylesheet" href="css\standard_html.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="index.html#section"></a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#note"><i class="fa fa-check"></i>Note</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#bayesian-probability"><i class="fa fa-check"></i>Bayesian Probability</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="a-hands-on-example.html"><a href="a-hands-on-example.html"><i class="fa fa-check"></i>A Hands-on Example</a><ul>
<li class="chapter" data-level="" data-path="a-hands-on-example.html"><a href="a-hands-on-example.html#prior-likelihood-posterior-distributions"><i class="fa fa-check"></i>Prior, likelihood, &amp; posterior distributions</a></li>
<li class="chapter" data-level="" data-path="a-hands-on-example.html"><a href="a-hands-on-example.html#prior"><i class="fa fa-check"></i>Prior</a></li>
<li class="chapter" data-level="" data-path="a-hands-on-example.html"><a href="a-hands-on-example.html#likelihood"><i class="fa fa-check"></i>Likelihood</a></li>
<li class="chapter" data-level="" data-path="a-hands-on-example.html"><a href="a-hands-on-example.html#posterior"><i class="fa fa-check"></i>Posterior</a></li>
<li class="chapter" data-level="" data-path="a-hands-on-example.html"><a href="a-hands-on-example.html#posterior-predictive"><i class="fa fa-check"></i>Posterior predictive</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="regression-models.html"><a href="regression-models.html"><i class="fa fa-check"></i>Regression Models</a><ul>
<li class="chapter" data-level="" data-path="regression-models.html"><a href="regression-models.html#example-linear-regression-model"><i class="fa fa-check"></i>Example: Linear Regression Model</a></li>
<li class="chapter" data-level="" data-path="regression-models.html"><a href="regression-models.html#setup"><i class="fa fa-check"></i>Setup</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-exploration.html"><a href="model-exploration.html"><i class="fa fa-check"></i>Model Exploration</a><ul>
<li class="chapter" data-level="" data-path="model-exploration.html"><a href="model-exploration.html#monitoring-convergence"><i class="fa fa-check"></i>Monitoring Convergence</a></li>
<li class="chapter" data-level="" data-path="model-exploration.html"><a href="model-exploration.html#model-checking"><i class="fa fa-check"></i>Model Checking</a></li>
<li class="chapter" data-level="" data-path="model-exploration.html"><a href="model-exploration.html#summary"><i class="fa fa-check"></i>Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-enhancements.html"><a href="model-enhancements.html"><i class="fa fa-check"></i>Model Enhancements</a><ul>
<li class="chapter" data-level="" data-path="model-enhancements.html"><a href="model-enhancements.html#generating-new-variables-of-interest"><i class="fa fa-check"></i>Generating New Variables of Interest</a></li>
<li class="chapter" data-level="" data-path="model-enhancements.html"><a href="model-enhancements.html#robust-regression"><i class="fa fa-check"></i>Robust Regression</a></li>
<li class="chapter" data-level="" data-path="model-enhancements.html"><a href="model-enhancements.html#generalized-linear-model"><i class="fa fa-check"></i>Generalized Linear Model</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="issues.html"><a href="issues.html"><i class="fa fa-check"></i>Issues</a><ul>
<li class="chapter" data-level="" data-path="issues.html"><a href="issues.html#debugging"><i class="fa fa-check"></i>Debugging</a></li>
<li class="chapter" data-level="" data-path="issues.html"><a href="issues.html#choice-of-prior"><i class="fa fa-check"></i>Choice of Prior</a></li>
<li class="chapter" data-level="" data-path="issues.html"><a href="issues.html#sampling-procedure"><i class="fa fa-check"></i>Sampling Procedure</a></li>
<li class="chapter" data-level="" data-path="issues.html"><a href="issues.html#number-of-draws-thinning-warm-up"><i class="fa fa-check"></i>Number of draws, thinning, warm-up</a></li>
<li class="chapter" data-level="" data-path="issues.html"><a href="issues.html#model-complexity"><i class="fa fa-check"></i>Model Complexity</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="summary-2.html"><a href="summary-2.html"><i class="fa fa-check"></i>Summary</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i>Appendix</a><ul>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#maximum-likelihood-review"><i class="fa fa-check"></i>Maximum Likelihood Review</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#linear-model"><i class="fa fa-check"></i>Linear Model</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#binomial-likelihood-example"><i class="fa fa-check"></i>Binomial Likelihood Example</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#modeling-languages"><i class="fa fa-check"></i>Modeling Languages</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#bugs-example"><i class="fa fa-check"></i>BUGS Example</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#jags-example"><i class="fa fa-check"></i>JAGS Example</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#metropolis-hastings-example"><i class="fa fa-check"></i>Metropolis Hastings Example</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#hamiltonian-monte-carlo-example"><i class="fa fa-check"></i>Hamiltonian Monte Carlo Example</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a><ul>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html#texts"><i class="fa fa-check"></i>Texts</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html#other"><i class="fa fa-check"></i>Other</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><span style="font-size:250%; font-style:italic; font-family:&#39;Alex Brush&#39; ">Bayesian Basics</span></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-exploration" class="section level1">
<h1>Model Exploration</h1>
<p>As with modeling in traditional approaches, it is not enough to simply run a model and go with whatever results are returned without further inspection. One must examine the results to assess model integrity and have more confidence in the results that have been produced<a href="#fn32" class="footnoteRef" id="fnref32"><sup>32</sup></a>.</p>
<div id="monitoring-convergence" class="section level2">
<h2>Monitoring Convergence</h2>
<p>There are various ways to assess whether or not the model has converged to a target distribution<a href="#fn33" class="footnoteRef" id="fnref33"><sup>33</sup></a>, but as with more complex models in MLE, there is nothing that can tell you for sure that you’ve hit upon <em>the</em> solution. As a starting point, Stan or other modeling environments will spit out repeated warnings or errors if something is egregiously wrong, or perhaps take an extraordinarily long time to complete relative to expectations, if it ever finishes at all. Assuming you’ve at least gotten past that point, there is more to be done.</p>
<div id="visual-inspection-traceplot-densities" class="section level3">
<h3>Visual Inspection: Traceplot &amp; Densities</h3>
<p>In the previous model we noted the traceplot for a single parameter, and a visual approach to monitoring convergence is certainly one good method. In general we look for a plot that shows random scatter around a mean value, and our model results suggest that the chains mixed well and the traceplot looked satisfactory.</p>
<p><img src="img/badchains.svg" style="display:block; margin: 0 auto;"  width=50%></p>
<p>This is an example where things have gone horribly wrong. The chains never converge nor do they mix with one another. One reason for running multiple chains is that any individual chain might converge toward one target, while another chain might converge elsewhere, and this would still be a problem. Also you might see otherwise healthy chains get stuck on occasion over the course of the series, which might suggest more model tweaking or a change in the sampler settings is warranted.</p>
<p>We can examine the mixed chains and density plots of the posterior with standard functions in the <span class="pack">rstan</span> package displayed previously, various functions in the <span class="pack">bayesplot</span> package, or interactively via <span class="pack">shinyStan</span> package and its <span class="func">launch_shiny</span> function. In the Bayesian approach, increasing amounts of data leads to a posterior distribution of the parameter vector approaching multivariate normality. The following shows a density, trace and autocorrelation plots for one of the regression coefficients using <span class="pack">shinyStan</span>.</p>
<p><br> <img src="img/shinyStan.png" style="display:block; margin: 0 auto;"></p>
</div>
<div id="statistical-measures" class="section level3">
<h3>Statistical Measures</h3>
<p>To go along with visual inspection, we can examine various statistics that might help our determination of convergence or lack thereof. Gelman and Rubin’s <span class="emph">potential scale reduction factor</span>, <span class="math inline">\(\hat{R}\)</span>, provides an estimate of convergence based on the variance of an estimated parameter <span class="math inline">\(\theta\)</span> between chains, and the variance within a chain. It is interpreted as the factor by which the variance in the estimate might be reduced with longer chains. We are looking for a value near 1 (and at the very least less than 1.1), and it will get there as <span class="math inline">\(N_{sim} \rightarrow \infty\)</span>. In the regression model things are looking good in this respect.</p>
<table style="width:35%;">
<colgroup>
<col width="11%" />
<col width="15%" />
<col width="8%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">rhat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">beta[1]</td>
<td align="right">4.89498</td>
<td align="right">1.0002</td>
</tr>
<tr class="even">
<td align="left">beta[2]</td>
<td align="right">0.08276</td>
<td align="right">1.0012</td>
</tr>
<tr class="odd">
<td align="left">beta[3]</td>
<td align="right">-1.46715</td>
<td align="right">0.9997</td>
</tr>
<tr class="even">
<td align="left">beta[4]</td>
<td align="right">0.82241</td>
<td align="right">0.9995</td>
</tr>
<tr class="odd">
<td align="left">sigma</td>
<td align="right">2.03040</td>
<td align="right">0.9998</td>
</tr>
</tbody>
</table>
<p>The <span class="pack">coda</span> package provides other convergence statistics based on Geweke (1992) and Heidelberger and Welch (1983). Along with those statistics, it also has plots for the <span class="math inline">\(\hat{R}\)</span> and Geweke diagnostics.</p>
</div>
<div id="autocorrelation" class="section level3">
<h3>Autocorrelation</h3>
<p>As noted previously, each estimate in the MCMC process is serially correlated with the previous estimates by definition. Furthermore, other aspects of the data, model, and estimation settings may contribute to this. Higher serial correlation typically has the effect of requiring more samples in order to get to a stationary distribution. If inspection of the traceplots look more <em>snake-like</em> than like a fat hairy caterpillar, this might suggest such a situation, and that more samples are required.</p>
<p>We can also look at the autocorrelation plot, in which the chain’s correlation with successive lags of the chain are plotted. The first plot is the autocorrelation plot from our model (starting at lag 1). The correlation is low to begin with and then just bounces around zero after. The next plot shows a case of high serial correlation, where the correlation with the first lag is high and the correlation persists even after longer lags. A longer chain with more thinning could help with this.</p>
<p><img src="img/acfPlotNoSerial.svg" style="display:block; margin: 0 auto;" width=50%> <img src="img/acfPlotSerial.svg" style="display:block; margin: 0 auto;" width=50%></p>
<p>The effective number of simulation draws is provided as <span class="math inline">\(n_{\textrm{eff}}\)</span> in the Stan output, and is similarly obtained in BUGS/JAGS. Ideally, we would desire this number to equal the number of posterior draws requested, and in the presence of essentially no autocorrelation the values would be equal. This is not a requirement though, and technically a low number of draws would still be usable. However, a notable discrepancy might suggest there are some issues with the model, or simply that longer chains could be useful. In our current model, all our effective sample sizes are at or near the total number of posterior draws.</p>
<table style="width:33%;">
<colgroup>
<col width="11%" />
<col width="15%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">ess</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">beta[1]</td>
<td align="right">4.89498</td>
<td align="right">2951</td>
</tr>
<tr class="even">
<td align="left">beta[2]</td>
<td align="right">0.08276</td>
<td align="right">3000</td>
</tr>
<tr class="odd">
<td align="left">beta[3]</td>
<td align="right">-1.46715</td>
<td align="right">3000</td>
</tr>
<tr class="even">
<td align="left">beta[4]</td>
<td align="right">0.82241</td>
<td align="right">2862</td>
</tr>
<tr class="odd">
<td align="left">sigma</td>
<td align="right">2.03040</td>
<td align="right">2886</td>
</tr>
</tbody>
</table>
<p><span class="emph">Monte Carlo error</span> is an estimate of the uncertainty contributed by only having a finite number of posterior draws. Typically we’d want roughly less than 5% of the posterior standard deviation (reported right next to it in the Stan output), but might as well go for less than 1%. With no autocorrelation it would equal <span class="math inline">\(\sqrt{\frac{var(\theta)}{n_{\textrm{eff}}}}\)</span><a href="#fn34" class="footnoteRef" id="fnref34"><sup>34</sup></a>. and <span class="math inline">\(n_{\textrm{eff}}\)</span> would equal the number of simulation draws requested.</p>
<table style="width:42%;">
<colgroup>
<col width="19%" />
<col width="9%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"> </th>
<th align="right">mean</th>
<th align="right">se_mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>beta[1]</strong></td>
<td align="right">4.895</td>
<td align="right">0.002</td>
</tr>
<tr class="even">
<td align="left"><strong>beta[2]</strong></td>
<td align="right">0.083</td>
<td align="right">0.002</td>
</tr>
<tr class="odd">
<td align="left"><strong>beta[3]</strong></td>
<td align="right">-1.467</td>
<td align="right">0.002</td>
</tr>
<tr class="even">
<td align="left"><strong>beta[4]</strong></td>
<td align="right">0.822</td>
<td align="right">0.002</td>
</tr>
<tr class="odd">
<td align="left"><strong>sigma</strong></td>
<td align="right">2.030</td>
<td align="right">0.002</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="model-checking" class="section level2">
<h2>Model Checking</h2>
<p>Checking the model for suitability is crucial to the analytical process<a href="#fn35" class="footnoteRef" id="fnref35"><sup>35</sup></a>. Assuming initial diagnostic inspection for convergence has proven satisfactory, we must then see if the model makes sense in its own right. This can be a straightforward process in many respects, and with Bayesian analysis one has a much richer environment in which to do so compared to traditional methods.</p>
<div id="sensitivity-analysis" class="section level3">
<h3>Sensitivity Analysis</h3>
<p>Sensitivity analysis entails checks on our model settings to see if changes in them, perhaps even slight ones, result in changes in posterior inferences. This may take the form of comparing models with plausible but different priors, different sampling distributions, or differences in other aspects of the model such as the inclusion or exclusion of explanatory variables. While an exhaustive check is impossible, at least some effort in this area should be made.</p>
</div>
<div id="predictive-accuracy-model-comparison" class="section level3">
<h3>Predictive Accuracy &amp; Model Comparison</h3>
<p>A standard way to check for model adequacy is simply to investigate whether the predictions on new data are accurate. In general, the measure of predictive accuracy will be specific to the data problem, and involve posterior simulation of the sort covered in the next section. In addition, while oftentimes new data is hard to come by, assuming one has sufficient data to begin with, one could set aside part of it specifically for this purpose. In this manner one trains and tests the model in much the same fashion as machine learning approaches. In fact, one can incorporate the validation process as an inherent part of the modeling process in the Bayesian context just as you would there.</p>
<p>For model comparison of out of sample predictive performance, there are information measures similar to the Akaike information criterion (AIC), that one could use in the Bayesian environment. One not to use is the so-called Bayesian information criterion (or BIC), which is not actually Bayesian nor a measure of predictive accuracy. BUGS provides the DIC, or deviance information criterion, as part of its summary output, which is a somewhat Bayesian version of the AIC. More recently developed, the WAIC, or Watanabe-AIC<a href="#fn36" class="footnoteRef" id="fnref36"><sup>36</sup></a>, is a more fully Bayesian approach. Under some conditions, the DIC and WAIC measures are asymptotically equivalent to Bayesian leave-one-out cross validation, as the AIC is under the classical setting.</p>
</div>
<div id="posterior-predictive-checking-statistical" class="section level3">
<h3>Posterior Predictive Checking: Statistical</h3>
<p>For an overall assessment of model fit, we can examine how well the model can reproduce the data at hand given the <span class="math inline">\(\theta\)</span> draws from the posterior. We discussed earlier the <span class="emph">posterior predictive distribution</span> for a future observation <span class="math inline">\(\tilde{y}\)</span>, <span class="math inline">\(p(\tilde{y}|y) = \int p(\tilde{y}|\theta)p(\theta|y)\mathrm{d}\theta\)</span>, and here we’ll dive in to using it explicitly. There are two sources of uncertainty in our regression model, the variance in y not explained by the model (<span class="math inline">\(\sigma^2\)</span>), and posterior uncertainty in the parameters due to having a finite sample size. As <span class="math inline">\(N\rightarrow\infty\)</span>, the latter goes to zero, and so we can simulate draws of <span class="math inline">\(\tilde{y} \sim N(\tilde{X}\beta, \sigma^2I)\)</span><a href="#fn37" class="footnoteRef" id="fnref37"><sup>37</sup></a>. If <span class="math inline">\(\tilde{X}\)</span> is the model data as in the following, then we will refer to <span class="math inline">\(y^{\textrm{Rep}}\)</span> instead of <span class="math inline">\(\tilde{y}\)</span>.</p>
<p>For our model this entails extracting the simulated values from the model object, and taking a random draw from the normal distribution based on the <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span> that are drawn to produce our <span class="emph">replicated data</span>, <span class="math inline">\(y^{\textrm{Rep}}\)</span> (see <span class="citation">Gelman et al. (<a href="#ref-gelman_bda">2013</a>)</span>, Appendix C). In what follows, I write out the process explicitly, but <span class="pack">bayesplot</span>, <span class="pack">rstanarm</span>, and <span class="pack">brms</span> make this straightforward, possibly with a single line of code, the latter packages using <span class="pack">bayesplot</span>. In addition, it’s often simpler to create the <span class="math inline">\(y^{\textrm{Rep}}\)</span> as part of your generated quantities section of the model code if modeling with Stan explicitly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">betas =<span class="st"> </span>theta$beta
sigmas =<span class="st"> </span>theta$sigma
nsims =<span class="st"> </span><span class="kw">length</span>(theta$sigma)

<span class="co"># produce the replications and inspect</span>
yRep =<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span>:nsims, function(s) <span class="kw">rnorm</span>(<span class="dv">250</span>, X%*%betas[s,], sigmas[s]))
<span class="kw">str</span>(yRep)</code></pre></div>
<pre><code> num [1:250, 1:3000] 4.54 4.22 1.45 3.72 9.06 ...</code></pre>
<p>With the <span class="math inline">\(y^{\textrm{Rep}}\)</span> in hand we can calculate all manner of statistics that might be of interest<a href="#fn38" class="footnoteRef" id="fnref38"><sup>38</sup></a>.</p>
<p>As a starting point, we can check our minimum value among the replicated data sets versus that observed in the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">min_rep =<span class="st"> </span><span class="kw">apply</span>(yRep, <span class="dv">2</span>, min)
min_y =<span class="st"> </span><span class="kw">min</span>(y)
<span class="kw">hist</span>(min_rep, <span class="dt">main=</span><span class="st">&#39;&#39;</span>); <span class="kw">abline</span>(<span class="dt">v=</span>min_y)
<span class="kw">c</span>(<span class="kw">mean</span>(min_rep), min_y)</code></pre></div>
<pre><code>[1] -2.828134 -6.056495</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.table</span>(<span class="kw">table</span>(min_rep&gt;min_y))</code></pre></div>
<pre><code>
      FALSE        TRUE 
0.006333333 0.993666667 </code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sort</span>(y)[<span class="dv">1</span>:<span class="dv">5</span>]</code></pre></div>
<pre><code>[1] -6.0564952 -3.2320527 -2.6358579 -2.1649084 -0.8366149</code></pre>
<p><img src="img/histofyrepMinimum.svg" style="display:block; margin: 0 auto;" width=50%, height=30%></p>
<p>These results suggest we may be having difficulty picking up the lower tail of the target variable, as our average minimum is notably higher than that seen in the data, and almost all our minimums are greater than the observed minimum (<span class="math inline">\(p=.99\)</span>). While in this case where we are dealing with a simulated data set and we know that assuming the normal distribution for our sampling distribution is appropriate, this might otherwise have given us pause for further consideration. A possible solution would be to assume a <span class="math inline">\(t\)</span> distribution for the likelihood, which would have fatter tails and thus possibly be better able to handle extreme values. We’ll show an example of this later. In this case it is just that by chance one of the <span class="math inline">\(y\)</span> values, -6.056, is fairly extreme relative to the others. Also, it is typically difficult to capture extreme values in practice. As a comparison, the model actually captures the 5<sup>th</sup>, 10<sup>th</sup> (shown), and 25<sup>th</sup> quantile values very well.</p>
<p><img src="img/histofyrepQ10.svg" style="display:block; margin: 0 auto;" width=50%></p>
<p><span style="font-size:.75em">See <span class="func">ppc_stat</span> in <span class="pack">bayesplot</span>.</span></p>
<p>In general, we can devise a test statistic, <span class="math inline">\(T_{\textrm{Rep}}\)</span>, and associated p-value to check <em>any</em> particular result of interest based on the simulated data. The p-value in this context is simply the percentage of times the statistic of interest is equal to or more extreme than the statistic, <span class="math inline">\(T_y\)</span>, calculated for the original data. Thus p-values near 0 or 1 are indicative of areas where the model is falling short in some fashion. Sometimes <span class="math inline">\(T_y\)</span> may be based on the <span class="math inline">\(\theta\)</span> parameters being estimated, and thus you’d have a <span class="math inline">\(T_y\)</span> for every posterior draw. In such a case one might examine the scatterplot of <span class="math inline">\(T_{\textrm{Rep}}\)</span> vs. <span class="math inline">\(T_y\)</span>, or examine a density plot of the difference between the two. In short, this is an area where one can get creative, and the <span class="pack">bayesplot</span> package can help with make this fairly easy. However, it must be stressed that we are not trying to accept or reject a model hypothesis as in the frequentist setting- we’re not going to throw a model out because of an extreme p-value in our posterior predictive check. We are merely trying to understand the model’s shortcomings as best we can, and make appropriate adjustments if applicable. It is often the case that the model will still be good enough for practical purposes.</p>
</div>
<div id="posterior-predictive-checking-graphical" class="section level3">
<h3>Posterior Predictive Checking: Graphical</h3>
<p>As there are any number of ways to do statistical posterior predictive checks, we have many options for graphical inspection as well. As a starting point I show a graph of our average fitted value versus the observed data. The average is over all posterior draws of <span class="math inline">\(\theta\)</span>.</p>
<p><img src="img/posteriorPredictiveFittedvsObserved.svg" style="display:block; margin: 0 auto;" width=50%></p>
<p><span style="font-size:.75em">See <span class="func">ppc_scatter_avg</span> in <span class="pack">bayesplot</span>.</span></p>
<p>Next, I show density plots for a random sample of 20 of the replicated data sets along with that of the original data (shaded). In general it looks like we’re doing pretty well here. The subsequent figure displays the density plot for individual predictions for a single value of <span class="math inline">\(y\)</span> from our data. While it looks like some predictions were low for that value, in general the model captures this particular observation of the data decently.</p>
<p><img src="img/yRepDensity.svg" style="display:block; margin: 0 auto;" width=50%> <img src="img/posteriorPredictiveFittedY.svg" style="display:block; margin: 0 auto;" width=50%></p>
<p><span style="font-size:.75em">See <span class="func">ppc_dens_overlay</span> in <span class="pack">bayesplot</span>.</span></p>
<p>We can also examine residual plots of <span class="math inline">\(y - E(y|X,\theta)\)</span> as with standard analysis, shown as the final two figures for this section. The first shows such <em>realized</em> residuals, so-called as they are based on a posterior draw of <span class="math inline">\(\theta\)</span> rather than point estimation of the parameters, versus the expected values from the model. The next plot shows the average residual against the average fitted value. No discernible patterns are present, so we may conclude that the model is adequate in this regard<a href="#fn39" class="footnoteRef" id="fnref39"><sup>39</sup></a>.</p>
<p><img src="img/posteriorPredictiveResidualRaw.svg" style="display:block; margin: 0 auto;" width=50%> <img src="img/posteriorPredictiveResidualAvg.svg" style="display:block; margin: 0 auto;" width=50%></p>
</div>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>As with standard approaches, every model should be checked to see whether it holds up under scrutiny. The previous discussion suggests only a few ways one might go about checking whether the model is worthwhile, but this is a very flexible area where one can answer questions beyond model adequacy and well beyond what traditional models can tell us. Not only is this phase of analysis a necessity, one can use it to explore a vast array of potential questions the data presents, and maybe even answer a few.</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-gelman_bda">
<p>Gelman, Andrew, John B. Carlin, Hal S. Stern, David B. Dunson, Aki Vehtari, and Donald B. Rubin. 2013. <em>Bayesian Data Analysis</em>. 3rd ed.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="32">
<li id="fn32"><p>I wonder how many results have been published on models that didn’t converge with the standard MLE. People will often ignore warnings as long as they get some sort of result.<a href="model-exploration.html#fnref32">↩</a></p></li>
<li id="fn33"><p>Recall again that we are looking for convergence to a distribution, not a point estimate of a specific parameter.<a href="model-exploration.html#fnref33">↩</a></p></li>
<li id="fn34"><p>This is the ‘naive’ estimate the <span class="pack">coda</span> package provides in its summary output.<a href="model-exploration.html#fnref34">↩</a></p></li>
<li id="fn35"><p>Gelman devotes an entire chapter to this topic to go along with examples of model checking throughout his text. Much of this section follows that outline.<a href="model-exploration.html#fnref35">↩</a></p></li>
<li id="fn36"><p>See <a href="http://www.stat.columbia.edu/~gelman/research/published/waic_understand3.pdf">Gelman et al. (2013)</a> for a review and references. See <a href="http://www.stat.columbia.edu/~gelman/research/unpublished/waic_stan.pdf">Vehtari &amp; Gelman (2014)</a> for some more on WAIC, as well as the R package <span class="pack">loo</span>.<a href="model-exploration.html#fnref36">↩</a></p></li>
<li id="fn37"><p>Technically, in the conjugate case the posterior predictive is t-distributed because of the uncertainty in the parameters, though it doesn’t take much sample size for simple models to get to approximately normal. Conceptually, with <span class="math inline">\(\hat{\beta}\)</span> being our mean <span class="math inline">\(\beta\)</span> estimate from the posterior, this can be represented as: <br> <span class="math inline">\(\tilde{y} \sim t(\tilde{X}\hat{\beta}, \sigma^2 + \textrm{parUnc}, \textrm{df}=N-k)\)</span><a href="model-exploration.html#fnref37">↩</a></p></li>
<li id="fn38"><p>In many cases you might want to produce this in the generated quantities section of your Stan code, but doing so outside of it will keep the <span class="objclass">stanfit</span> object smaller, which may be desirable.<a href="model-exploration.html#fnref38">↩</a></p></li>
<li id="fn39"><p>The two plots directly above replicate the figures in 6.11 in Gelman 2013.<a href="model-exploration.html#fnref39">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="regression-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="model-enhancements.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
